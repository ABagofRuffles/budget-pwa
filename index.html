<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuickBudget</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      -webkit-text-size-adjust: 100%;
      line-height: 1.45;
      color: #0f172a;
      --space-2xs: 2px;
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 12px;
      --space-lg: 16px;
      --space-xl: 24px;
      --radius-sm: 8px;
      --radius-md: 12px;
      --border-light: #e2e8f0;
      --border-mid: #cbd5e1;
      --surface-card: #ffffff;
      --surface-muted: #f8fafc;
      --surface-pill: #f1f5f9;
      --accent: #0f766e;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--surface-muted);
      color: inherit;
      overflow-x: hidden;
    }

    .app-shell {
      width: min(100%, 620px);
      margin: 0 auto;
      padding: clamp(16px, 4vw, 26px);
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }

    h1 {
      font-size: 22px;
      margin: 0;
      letter-spacing: -0.01em;
    }

    .card {
      background: var(--surface-card);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--space-lg);
      margin-bottom: var(--space-md);
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
    }

    .card:last-of-type {
      margin-bottom: 0;
    }

    .worksheet-card,
    .worksheet-summary {
      margin-bottom: 0;
    }

    .worksheet-card {
      gap: var(--space-lg);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: calc(var(--space-xs) + 2px);
    }

    label {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }

    input,
    select,
    button {
      width: 100%;
      min-height: 44px;
      padding: calc(var(--space-xs) + 2px) var(--space-md);
      font-size: 16px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-mid);
      font-family: inherit;
    }

    input:focus-visible,
    select:focus-visible,
    button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    input,
    select {
      background: #ffffff;
      color: inherit;
    }

    input::placeholder {
      color: #94a3b8;
    }

    button {
      border: none;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
    }

    .btn {
      background: var(--accent);
      color: #ffffff;
    }

    .ghost {
      background: var(--surface-pill);
      color: inherit;
      border: 1px solid var(--border-light);
    }

    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-sm);
    }

    .totals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space-sm);
    }

    .pill {
      background: var(--surface-pill);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: calc(var(--space-xs) + 2px) var(--space-md);
      display: flex;
      flex-direction: column;
      gap: var(--space-xs);
    }

    .pill strong {
      font-size: 18px;
      font-variant-numeric: tabular-nums;
    }

    header button {
      width: auto;
      flex-shrink: 0;
      padding-inline: var(--space-lg);
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: var(--space-2xs);
    }

    li {
      display: flex;
      justify-content: space-between;
      gap: var(--space-sm);
      padding: calc(var(--space-xs) + 2px) 0;
      border-bottom: 1px dashed var(--border-light);
      align-items: flex-start;
      flex-wrap: wrap;
    }

    li > div:last-child {
      text-align: right;
    }

    li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }

    li strong {
      display: inline-block;
      min-width: 80px;
    }

    .neg { color: #b91c1c; }
    .pos { color: #0369a1; }

    small { color: #64748b; }

    h2 {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
      color: #1e293b;
    }

    h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0;
      color: #475569;
    }

    .subtotal,
    .section-total {
      text-align: right;
      font-weight: 600;
      margin-top: var(--space-sm);
      color: #334155;
    }

    #worksheet {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      margin-top: var(--space-xl);
    }

    .category-block {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .category-block + .category-block {
      padding-top: var(--space-md);
      margin-top: var(--space-md);
      border-top: 1px solid var(--border-light);
    }

    .simple-block {
      padding-top: 0;
      margin-top: 0;
      border-top: none;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover,
    a:focus-visible {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        margin-bottom: var(--space-lg);
      }

      header button {
        width: 100%;
        align-self: stretch;
      }

      .row {
        grid-template-columns: 1fr;
        gap: var(--space-md);
      }
    }

    @media (prefers-color-scheme: dark) {
      :root {
        color: #f8fafc;
        --border-light: #334155;
        --border-mid: #475569;
        --surface-card: #1e293b;
        --surface-muted: #0f172a;
        --surface-pill: #1e293b;
      }

      input,
      select {
        background: #0f172a;
        color: inherit;
      }

      button {
        color: inherit;
      }

      label {
        color: #cbd5f5;
      }

      h2 { color: inherit; }
      h3 { color: #cbd5f5; }

      li {
        border-bottom-color: var(--border-light);
      }

      .category-block + .category-block {
        border-top-color: var(--border-light);
      }

      small { color: #94a3b8; }

      .subtotal,
      .section-total {
        color: #cbd5f5;
      }

      .neg { color: #f87171; }
      .pos { color: #38bdf8; }
    }
  </style>
</head>
<body>
  <main class="app-shell">
    <header>
      <h1>QuickBudget</h1>
      <button id="exportBtn" class="ghost">Export CSV</button>
    </header>

    <div class="card totals-card">
      <div class="totals">
        <div class="pill">
          <div><small>Income</small></div>
          <strong id="incomeTotal">$0.00</strong>
        </div>
        <div class="pill">
          <div><small>Expenses</small></div>
          <strong id="expenseTotal">$0.00</strong>
        </div>
        <div class="pill">
          <div><small>Net</small></div>
          <strong id="netTotal">$0.00</strong>
        </div>
      </div>
    </div>

    <div class="card entry-card">
      <div class="field">
        <label for="desc">Description</label>
        <input id="desc" placeholder="e.g., Groceries, Paycheck" autocomplete="off" />
      </div>

      <div class="row">
        <div class="field">
          <label for="amt">Amount</label>
          <input id="amt" type="number" step="0.01" inputmode="decimal" placeholder="e.g., 45.67" />
        </div>
        <div class="field">
          <label for="type">Type</label>
          <select id="type">
            <option value="expense">Expense (-)</option>
            <option value="income">Income (+)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="cat">Category</label>
          <input id="cat" placeholder="e.g., Food, Rent, Gas" />
        </div>
        <div class="field">
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
      </div>

      <button id="addBtn" class="btn">Add</button>
    </div>

    <div class="card filters-card">
      <div class="row">
        <div class="field">
          <label for="search">Search</label>
          <input id="search" placeholder="Description or category" />
        </div>
        <div class="field">
          <label for="filterType">Type</label>
          <select id="filterType">
            <option value="all">All</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>
      </div>
      <ul id="list"></ul>
    </div>

    <div id="worksheet"></div>
  </main>

  <script>
    // --- Storage helpers (local only) ---
    const KEY = 'qb_txns_v1';
    const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

    // --- Elements ---
    const descEl = document.getElementById('desc');
    const amtEl = document.getElementById('amt');
    const typeEl = document.getElementById('type');
    const catEl = document.getElementById('cat');
    const dateEl = document.getElementById('date');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const filterTypeEl = document.getElementById('filterType');
    const incomeTotalEl = document.getElementById('incomeTotal');
    const expenseTotalEl = document.getElementById('expenseTotal');
    const netTotalEl = document.getElementById('netTotal');
    const exportBtn = document.getElementById('exportBtn');
    const worksheetEl = document.getElementById('worksheet');

    let txns = load();

    // --- Worksheet storage ---
    const WS_KEY = 'qb_ws_v1';
    let wsData = JSON.parse(localStorage.getItem(WS_KEY) || '{}');

    const WORKSHEET = [
      { title: 'Monthly Household Income', items: [
        'Primary take-home pay',
        'Secondary take-home pay',
        'Child support',
        'Alimony',
        'Other'
      ]},
      { title: 'Monthly Essential Expenses (Things You Need to Have)', categories: [
        { name: 'Housing', items: ['Mortgage or rent', 'Property taxes', 'Home/Renter\'s insurance', 'Other'] },
        { name: 'Utilities', items: ['Electricity', 'Natural gas', 'Water/Sewer', 'Cell phone', 'Internet/Cable', 'Trash'] },
        { name: 'Food', items: ['Groceries', 'Dining out', 'School/work lunches'] },
        { name: 'Transportation', items: ['Gas', 'Parking/Tolls', 'Maintenance', 'Public transportation'] },
        { name: 'Debt & Monthly Obligations', items: ['Credit card payments', 'Student loan payments', 'Child support', 'Alimony', 'Personal loan payments', 'Other debt'] },
        { name: 'Healthcare', items: ['Health insurance', 'Dental insurance', 'Medication', 'Medical bills', 'Other'] }
      ]},
      { title: 'Monthly Discretionary Expenses (Things You Want)', categories: [
        { name: 'Child & Dependent Care', items: ['Daycare/After-school', 'Babysitting', 'Summer camps', 'Other'] },
        { name: 'Education', items: ['Tuition', 'Books/Supplies', 'Student fees', 'Other'] },
        { name: 'Personal Care', items: ['Haircuts', 'Salon services', 'Gym memberships', 'Cosmetics/Toiletries'] },
        { name: 'Clothing', items: ['Adult clothing', 'Children\'s clothing', 'Dry cleaning', 'Laundry'] },
        { name: 'Gifts', items: ['Birthdays', 'Holidays', 'Charitable donations', 'Other'] },
        { name: 'Recreational', items: ['Hobbies', 'Vacation', 'Sporting events', 'Other'] },
        { name: 'Entertainment', items: ['Movies', 'Concerts', 'Streaming/Subscriptions', 'Other'] }
      ]},
      { title: 'Other Monthly Expenses', items: ['Miscellaneous'] }
    ];

    function saveWorksheet(){
      localStorage.setItem(WS_KEY, JSON.stringify(wsData));
    }

    function createWorksheetField(container, labelText, key){
      const field = document.createElement('div');
      field.className = 'field';
      const label = document.createElement('label');
      const input = document.createElement('input');
      const inputId = `ws-${key}`;
      label.textContent = labelText;
      label.htmlFor = inputId;
      input.type = 'number';
      input.step = '0.01';
      input.inputMode = 'decimal';
      input.id = inputId;
      if(wsData[key] !== undefined) input.value = wsData[key];
      input.addEventListener('input', ()=>{
        wsData[key] = parseFloat(input.value)||0;
        saveWorksheet();
        updateWorksheetTotals();
      });
      field.appendChild(label);
      field.appendChild(input);
      container.appendChild(field);
    }

    function renderWorksheet(){
      worksheetEl.innerHTML = '';
      WORKSHEET.forEach((section, si)=>{
        const card = document.createElement('div');
        card.className = 'card worksheet-card';
        const h2 = document.createElement('h2');
        h2.textContent = section.title;
        card.appendChild(h2);

        if(section.items){
          const simpleBlock = document.createElement('div');
          simpleBlock.className = 'category-block simple-block';
          section.items.forEach((item, ii)=>{
            const key = `${si}-0-${ii}`;
            createWorksheetField(simpleBlock, item, key);
          });
          card.appendChild(simpleBlock);
        }

        if(section.categories){
          section.categories.forEach((cat, ci)=>{
            const block = document.createElement('div');
            block.className = 'category-block';
            const h3 = document.createElement('h3');
            h3.textContent = cat.name;
            block.appendChild(h3);
            cat.items.forEach((item, ii)=>{
              const key = `${si}-${ci}-${ii}`;
              createWorksheetField(block, item, key);
            });
            const ctotal = document.createElement('div');
            ctotal.className = 'subtotal';
            ctotal.id = `cat-${si}-${ci}-total`;
            ctotal.textContent = 'Subtotal: $0.00';
            block.appendChild(ctotal);
            card.appendChild(block);
          });
        }

        const stotal = document.createElement('div');
        stotal.className = 'section-total';
        stotal.id = `sec-${si}-total`;
        stotal.textContent = 'Section Total: $0.00';
        card.appendChild(stotal);

        worksheetEl.appendChild(card);
      });

      const summary = document.createElement('div');
      summary.className = 'card worksheet-summary';
      summary.innerHTML = `
        <h2>Summary</h2>
        <div class="totals">
          <div class="pill"><div><small>Income</small></div><strong id="ws-income-total">$0.00</strong></div>
          <div class="pill"><div><small>Essential</small></div><strong id="ws-essential-total">$0.00</strong></div>
          <div class="pill"><div><small>Discretionary</small></div><strong id="ws-discretionary-total">$0.00</strong></div>
          <div class="pill"><div><small>Other</small></div><strong id="ws-other-total">$0.00</strong></div>
          <div class="pill"><div><small>Expenses Total</small></div><strong id="ws-expenses-total">$0.00</strong></div>
        </div>`;
      worksheetEl.appendChild(summary);

      updateWorksheetTotals();
    }

    function updateWorksheetTotals(){
      const totals = [0,0,0,0];
      WORKSHEET.forEach((section, si)=>{
        let secSum = 0;
        if(section.items){
          section.items.forEach((item, ii)=>{
            const key = `${si}-0-${ii}`;
            const val = wsData[key] || 0;
            secSum += val;
          });
        }
        if(section.categories){
          section.categories.forEach((cat, ci)=>{
            let catSum = 0;
            cat.items.forEach((item, ii)=>{
              const key = `${si}-${ci}-${ii}`;
              const val = wsData[key] || 0;
              catSum += val;
            });
            document.getElementById(`cat-${si}-${ci}-total`).textContent = 'Subtotal: ' + fmt(catSum);
            secSum += catSum;
          });
        }
        document.getElementById(`sec-${si}-total`).textContent = 'Section Total: ' + fmt(secSum);
        totals[si] = secSum;
      });
      const [inc, ess, dis, other] = totals;
      document.getElementById('ws-income-total').textContent = fmt(inc);
      document.getElementById('ws-essential-total').textContent = fmt(ess);
      document.getElementById('ws-discretionary-total').textContent = fmt(dis);
      document.getElementById('ws-other-total').textContent = fmt(other);
      document.getElementById('ws-expenses-total').textContent = fmt(ess + dis + other);
    }

    function fmt(n){ return (n<0?'-':'') + '$' + Math.abs(n).toFixed(2); }

    function render(){
      const q = searchEl.value.toLowerCase().trim();
      const ft = filterTypeEl.value;
      let income = 0, expense = 0;

      listEl.innerHTML = '';
      txns
        .filter(t => (ft==='all'||t.type===ft))
        .filter(t => !q || (t.desc.toLowerCase().includes(q) || (t.cat||'').toLowerCase().includes(q)))
        .sort((a,b)=> new Date(b.date||0) - new Date(a.date||0))
        .forEach(t=>{
          const li = document.createElement('li');
          const left = document.createElement('div');
          const right = document.createElement('div');

          left.innerHTML = `<strong>${t.desc}</strong><br><small>${t.cat||'—'} • ${t.date||'—'}</small>`;
          right.innerHTML = `<strong class="${t.type==='expense'?'neg':'pos'}">${fmt(t.type==='expense'?-t.amount:t.amount)}</strong><br><small><a href="#" data-id="${t.id}">Delete</a></small>`;
          li.appendChild(left); li.appendChild(right);
          listEl.appendChild(li);

          if(t.type==='income') income += t.amount; else expense += t.amount;
        });

      incomeTotalEl.textContent = fmt(income);
      expenseTotalEl.textContent = fmt(-expense);
      netTotalEl.textContent = fmt(income - expense);
    }

    function add(){
      const amount = parseFloat(amtEl.value);
      if(!descEl.value || isNaN(amount)) { alert('Add a description and amount'); return; }
      txns.push({
        id: crypto.randomUUID(),
        desc: descEl.value.trim(),
        amount: Math.abs(amount),
        type: typeEl.value,
        cat: catEl.value.trim(),
        date: dateEl.value || new Date().toISOString().slice(0,10)
      });
      save(txns);
      descEl.value=''; amtEl.value=''; catEl.value='';
      render();
    }

    // Delete handler (event delegation)
    listEl.addEventListener('click', e=>{
      const id = e.target.dataset?.id;
      if(id){ txns = txns.filter(t=>t.id!==id); save(txns); render(); }
    });

    // Wire up
    addBtn.addEventListener('click', add);
    searchEl.addEventListener('input', render);
    filterTypeEl.addEventListener('change', render);
    document.addEventListener('DOMContentLoaded', () => { render(); renderWorksheet(); });

    // Export CSV
    exportBtn.addEventListener('click', ()=>{
      const rows = [['Date','Type','Description','Category','Amount']];
      txns.forEach(t=> rows.push([t.date, t.type, t.desc, t.cat, t.amount]));
      const csv = rows.map(r=> r.map(x=> `"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quickbudget.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // PWA: register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
