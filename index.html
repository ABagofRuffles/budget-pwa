<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuickBudget</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
  <meta name="color-scheme" content="light dark">
  <style>
    :root { font-family: -apple-system, system-ui, sans-serif; }
    * { box-sizing: border-box; }
    body { margin: 0 auto; padding: 16px; max-width:600px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    h1 { font-size: 20px; margin: 0; }
    .card { border: 1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:14px; margin:8px 0 4px; }
    input, select, button { width:100%; padding:10px; font-size:16px; border-radius:10px; border:1px solid #ddd; }
    button { border:0; }
    .btn { background:#0f766e; color:white; }
    .ghost { background:#f1f5f9; }
    .row { display:flex; flex-wrap:wrap; gap:8px; }
    .row > * { flex:1 1 200px; min-width:0; }
    .totals { display:flex; gap:8px; }
    .pill { flex:1; background:#f8fafc; border:1px solid #eef; border-radius:12px; padding:8px; text-align:center; }
    ul { list-style:none; padding:0; margin:0; }
    li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; align-items:center; }
    .neg { color:#b91c1c; }
    .pos { color:#0369a1; }
    small { color:#64748b; }
    h2 { font-size:16px; margin:0 0 8px; }
    h3 { font-size:14px; margin:8px 0 4px; }
    .subtotal, .section-total { text-align:right; font-weight:bold; margin-top:4px; }
    @media (max-width: 600px) {
      .row { flex-direction:column; }
      body { padding:12px; }
    }
    @media (prefers-color-scheme: dark) {
      body { background:#0f172a; color:#f8fafc; }
      .card { background:#1e293b; border-color:#334155; }
      .ghost { background:#1e293b; color:#f8fafc; }
      input, select, button { background:#334155; color:#f8fafc; border:1px solid #475569; }
      .pill { background:#334155; border-color:#475569; }
      li { border-bottom-color:#334155; }
      .neg { color:#f87171; }
      .pos { color:#38bdf8; }
      small { color:#94a3b8; }
    }
  </style>
</head>
<body>
  <header>
    <h1>QuickBudget</h1>
    <button id="exportBtn" class="ghost">Export CSV</button>
  </header>

  <div class="card">
    <div class="totals">
      <div class="pill">
        <div><small>Income</small></div>
        <strong id="incomeTotal">$0.00</strong>
      </div>
      <div class="pill">
        <div><small>Expenses</small></div>
        <strong id="expenseTotal">$0.00</strong>
      </div>
      <div class="pill">
        <div><small>Net</small></div>
        <strong id="netTotal">$0.00</strong>
      </div>
    </div>
  </div>

  <div class="card">
    <label>Description</label>
    <input id="desc" placeholder="e.g., Groceries, Paycheck" autocomplete="off" />

    <div class="row">
      <div>
        <label>Amount</label>
        <input id="amt" type="number" step="0.01" inputmode="decimal" placeholder="e.g., 45.67" />
      </div>
      <div>
        <label>Type</label>
        <select id="type">
          <option value="expense">Expense (-)</option>
          <option value="income">Income (+)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Category</label>
        <input id="cat" placeholder="e.g., Food, Rent, Gas" />
      </div>
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
    </div>

    <button id="addBtn" class="btn" style="margin-top:10px;">Add</button>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px;">
      <input id="search" placeholder="Search description/category" />
      <select id="filterType">
        <option value="all">All</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </div>
    <ul id="list"></ul>
  </div>

  <div id="worksheet"></div>

  <script>
    // --- Storage helpers (local only) ---
    const KEY = 'qb_txns_v1';
    const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

    // --- Elements ---
    const descEl = document.getElementById('desc');
    const amtEl = document.getElementById('amt');
    const typeEl = document.getElementById('type');
    const catEl = document.getElementById('cat');
    const dateEl = document.getElementById('date');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const filterTypeEl = document.getElementById('filterType');
    const incomeTotalEl = document.getElementById('incomeTotal');
    const expenseTotalEl = document.getElementById('expenseTotal');
    const netTotalEl = document.getElementById('netTotal');
    const exportBtn = document.getElementById('exportBtn');
    const worksheetEl = document.getElementById('worksheet');

    let txns = load();

    // --- Worksheet storage ---
    const WS_KEY = 'qb_ws_v1';
    let wsData = JSON.parse(localStorage.getItem(WS_KEY) || '{}');

    const WORKSHEET = [
      { title: 'Monthly Household Income', items: [
        'Primary take-home pay',
        'Secondary take-home pay',
        'Child support',
        'Alimony',
        'Other'
      ]},
      { title: 'Monthly Essential Expenses (Things You Need to Have)', categories: [
        { name: 'Housing', items: ['Mortgage or rent', 'Property taxes', 'Home/Renter\'s insurance', 'Other'] },
        { name: 'Utilities', items: ['Electricity', 'Natural gas', 'Water/Sewer', 'Cell phone', 'Internet/Cable', 'Trash'] },
        { name: 'Food', items: ['Groceries', 'Dining out', 'School/work lunches'] },
        { name: 'Transportation', items: ['Gas', 'Parking/Tolls', 'Maintenance', 'Public transportation'] },
        { name: 'Debt & Monthly Obligations', items: ['Credit card payments', 'Student loan payments', 'Child support', 'Alimony', 'Personal loan payments', 'Other debt'] },
        { name: 'Healthcare', items: ['Health insurance', 'Dental insurance', 'Medication', 'Medical bills', 'Other'] }
      ]},
      { title: 'Monthly Discretionary Expenses (Things You Want)', categories: [
        { name: 'Child & Dependent Care', items: ['Daycare/After-school', 'Babysitting', 'Summer camps', 'Other'] },
        { name: 'Education', items: ['Tuition', 'Books/Supplies', 'Student fees', 'Other'] },
        { name: 'Personal Care', items: ['Haircuts', 'Salon services', 'Gym memberships', 'Cosmetics/Toiletries'] },
        { name: 'Clothing', items: ['Adult clothing', 'Children\'s clothing', 'Dry cleaning', 'Laundry'] },
        { name: 'Gifts', items: ['Birthdays', 'Holidays', 'Charitable donations', 'Other'] },
        { name: 'Recreational', items: ['Hobbies', 'Vacation', 'Sporting events', 'Other'] },
        { name: 'Entertainment', items: ['Movies', 'Concerts', 'Streaming/Subscriptions', 'Other'] }
      ]},
      { title: 'Other Monthly Expenses', items: ['Miscellaneous'] }
    ];

    function saveWorksheet(){
      localStorage.setItem(WS_KEY, JSON.stringify(wsData));
    }

    function renderWorksheet(){
      worksheetEl.innerHTML = '';
      WORKSHEET.forEach((section, si)=>{
        const card = document.createElement('div');
        card.className = 'card';
        const h2 = document.createElement('h2');
        h2.textContent = section.title;
        card.appendChild(h2);

        if(section.items){
          section.items.forEach((item, ii)=>{
            const label = document.createElement('label');
            label.textContent = item;
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.inputMode = 'decimal';
            const key = `${si}-0-${ii}`;
            if(wsData[key] !== undefined) input.value = wsData[key];
            input.addEventListener('input', ()=>{
              wsData[key] = parseFloat(input.value)||0;
              saveWorksheet();
              updateWorksheetTotals();
            });
            card.appendChild(label);
            card.appendChild(input);
          });
        }

        if(section.categories){
          section.categories.forEach((cat, ci)=>{
            const h3 = document.createElement('h3');
            h3.textContent = cat.name;
            card.appendChild(h3);
            cat.items.forEach((item, ii)=>{
              const label = document.createElement('label');
              label.textContent = item;
              const input = document.createElement('input');
              input.type = 'number';
              input.step = '0.01';
              input.inputMode = 'decimal';
              const key = `${si}-${ci}-${ii}`;
              if(wsData[key] !== undefined) input.value = wsData[key];
              input.addEventListener('input', ()=>{
                wsData[key] = parseFloat(input.value)||0;
                saveWorksheet();
                updateWorksheetTotals();
              });
              card.appendChild(label);
              card.appendChild(input);
            });
            const ctotal = document.createElement('div');
            ctotal.className = 'subtotal';
            ctotal.id = `cat-${si}-${ci}-total`;
            ctotal.textContent = 'Subtotal: $0.00';
            card.appendChild(ctotal);
          });
        }

        const stotal = document.createElement('div');
        stotal.className = 'section-total';
        stotal.id = `sec-${si}-total`;
        stotal.textContent = 'Section Total: $0.00';
        card.appendChild(stotal);

        worksheetEl.appendChild(card);
      });

      const summary = document.createElement('div');
      summary.className = 'card';
      summary.innerHTML = `
        <h2>Summary</h2>
        <div class="totals">
          <div class="pill"><div><small>Income</small></div><strong id="ws-income-total">$0.00</strong></div>
          <div class="pill"><div><small>Essential</small></div><strong id="ws-essential-total">$0.00</strong></div>
          <div class="pill"><div><small>Discretionary</small></div><strong id="ws-discretionary-total">$0.00</strong></div>
          <div class="pill"><div><small>Other</small></div><strong id="ws-other-total">$0.00</strong></div>
          <div class="pill"><div><small>Expenses Total</small></div><strong id="ws-expenses-total">$0.00</strong></div>
        </div>`;
      worksheetEl.appendChild(summary);

      updateWorksheetTotals();
    }

    function updateWorksheetTotals(){
      const totals = [0,0,0,0];
      WORKSHEET.forEach((section, si)=>{
        let secSum = 0;
        if(section.items){
          section.items.forEach((item, ii)=>{
            const key = `${si}-0-${ii}`;
            const val = wsData[key] || 0;
            secSum += val;
          });
        }
        if(section.categories){
          section.categories.forEach((cat, ci)=>{
            let catSum = 0;
            cat.items.forEach((item, ii)=>{
              const key = `${si}-${ci}-${ii}`;
              const val = wsData[key] || 0;
              catSum += val;
            });
            document.getElementById(`cat-${si}-${ci}-total`).textContent = 'Subtotal: ' + fmt(catSum);
            secSum += catSum;
          });
        }
        document.getElementById(`sec-${si}-total`).textContent = 'Section Total: ' + fmt(secSum);
        totals[si] = secSum;
      });
      const [inc, ess, dis, other] = totals;
      document.getElementById('ws-income-total').textContent = fmt(inc);
      document.getElementById('ws-essential-total').textContent = fmt(ess);
      document.getElementById('ws-discretionary-total').textContent = fmt(dis);
      document.getElementById('ws-other-total').textContent = fmt(other);
      document.getElementById('ws-expenses-total').textContent = fmt(ess + dis + other);
    }

    function fmt(n){ return (n<0?'-':'') + '$' + Math.abs(n).toFixed(2); }

    function render(){
      const q = searchEl.value.toLowerCase().trim();
      const ft = filterTypeEl.value;
      let income = 0, expense = 0;

      listEl.innerHTML = '';
      txns
        .filter(t => (ft==='all'||t.type===ft))
        .filter(t => !q || (t.desc.toLowerCase().includes(q) || (t.cat||'').toLowerCase().includes(q)))
        .sort((a,b)=> new Date(b.date||0) - new Date(a.date||0))
        .forEach(t=>{
          const li = document.createElement('li');
          const left = document.createElement('div');
          const right = document.createElement('div');

          left.innerHTML = `<strong>${t.desc}</strong><br><small>${t.cat||'—'} • ${t.date||'—'}</small>`;
          right.innerHTML = `<strong class="${t.type==='expense'?'neg':'pos'}">${fmt(t.type==='expense'?-t.amount:t.amount)}</strong><br><small><a href="#" data-id="${t.id}">Delete</a></small>`;
          li.appendChild(left); li.appendChild(right);
          listEl.appendChild(li);

          if(t.type==='income') income += t.amount; else expense += t.amount;
        });

      incomeTotalEl.textContent = fmt(income);
      expenseTotalEl.textContent = fmt(-expense);
      netTotalEl.textContent = fmt(income - expense);
    }

    function add(){
      const amount = parseFloat(amtEl.value);
      if(!descEl.value || isNaN(amount)) { alert('Add a description and amount'); return; }
      txns.push({
        id: crypto.randomUUID(),
        desc: descEl.value.trim(),
        amount: Math.abs(amount),
        type: typeEl.value,
        cat: catEl.value.trim(),
        date: dateEl.value || new Date().toISOString().slice(0,10)
      });
      save(txns);
      descEl.value=''; amtEl.value=''; catEl.value='';
      render();
    }

    // Delete handler (event delegation)
    listEl.addEventListener('click', e=>{
      const id = e.target.dataset?.id;
      if(id){ txns = txns.filter(t=>t.id!==id); save(txns); render(); }
    });

    // Wire up
    addBtn.addEventListener('click', add);
    searchEl.addEventListener('input', render);
    filterTypeEl.addEventListener('change', render);
    document.addEventListener('DOMContentLoaded', () => { render(); renderWorksheet(); });

    // Export CSV
    exportBtn.addEventListener('click', ()=>{
      const rows = [['Date','Type','Description','Category','Amount']];
      txns.forEach(t=> rows.push([t.date, t.type, t.desc, t.cat, t.amount]));
      const csv = rows.map(r=> r.map(x=> `"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quickbudget.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // PWA: register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
