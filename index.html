<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QuickBudget</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e">
  <style>
    :root { font-family: -apple-system, system-ui, sans-serif; }
    body { margin: 0; padding: 16px; }
    header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    h1 { font-size: 20px; margin: 0; }
    .card { border: 1px solid #eee; border-radius:12px; padding:12px; margin-bottom:12px; }
    label { display:block; font-size:14px; margin:8px 0 4px; }
    input, select, button { width:100%; padding:10px; font-size:16px; border-radius:10px; border:1px solid #ddd; }
    button { border:0; }
    .btn { background:#0f766e; color:white; }
    .ghost { background:#f1f5f9; }
    .row { display:flex; gap:8px; }
    .row > * { flex:1; }
    .totals { display:flex; gap:8px; }
    .pill { flex:1; background:#f8fafc; border:1px solid #eef; border-radius:12px; padding:8px; text-align:center; }
    ul { list-style:none; padding:0; margin:0; }
    li { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px dashed #eee; align-items:center; }
    .neg { color:#b91c1c; }
    .pos { color:#0369a1; }
    small { color:#64748b; }
  </style>
</head>
<body>
  <header>
    <h1>QuickBudget</h1>
    <button id="exportBtn" class="ghost">Export CSV</button>
  </header>

  <div class="card">
    <div class="totals">
      <div class="pill">
        <div><small>Income</small></div>
        <strong id="incomeTotal">$0.00</strong>
      </div>
      <div class="pill">
        <div><small>Expenses</small></div>
        <strong id="expenseTotal">$0.00</strong>
      </div>
      <div class="pill">
        <div><small>Net</small></div>
        <strong id="netTotal">$0.00</strong>
      </div>
    </div>
  </div>

  <div class="card">
    <label>Description</label>
    <input id="desc" placeholder="e.g., Groceries, Paycheck" autocomplete="off" />

    <div class="row">
      <div>
        <label>Amount</label>
        <input id="amt" type="number" step="0.01" inputmode="decimal" placeholder="e.g., 45.67" />
      </div>
      <div>
        <label>Type</label>
        <select id="type">
          <option value="expense">Expense (-)</option>
          <option value="income">Income (+)</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Category</label>
        <input id="cat" placeholder="e.g., Food, Rent, Gas" />
      </div>
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
    </div>

    <button id="addBtn" class="btn" style="margin-top:10px;">Add</button>
  </div>

  <div class="card">
    <div class="row" style="margin-bottom:8px;">
      <input id="search" placeholder="Search description/category" />
      <select id="filterType">
        <option value="all">All</option>
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </div>
    <ul id="list"></ul>
  </div>

  <script>
    // --- Storage helpers (local only) ---
    const KEY = 'qb_txns_v1';
    const load = () => JSON.parse(localStorage.getItem(KEY) || '[]');
    const save = (data) => localStorage.setItem(KEY, JSON.stringify(data));

    // --- Elements ---
    const descEl = document.getElementById('desc');
    const amtEl = document.getElementById('amt');
    const typeEl = document.getElementById('type');
    const catEl = document.getElementById('cat');
    const dateEl = document.getElementById('date');
    const addBtn = document.getElementById('addBtn');
    const listEl = document.getElementById('list');
    const searchEl = document.getElementById('search');
    const filterTypeEl = document.getElementById('filterType');
    const incomeTotalEl = document.getElementById('incomeTotal');
    const expenseTotalEl = document.getElementById('expenseTotal');
    const netTotalEl = document.getElementById('netTotal');
    const exportBtn = document.getElementById('exportBtn');

    let txns = load();

    function fmt(n){ return (n<0?'-':'') + '$' + Math.abs(n).toFixed(2); }

    function render(){
      const q = searchEl.value.toLowerCase().trim();
      const ft = filterTypeEl.value;
      let income = 0, expense = 0;

      listEl.innerHTML = '';
      txns
        .filter(t => (ft==='all'||t.type===ft))
        .filter(t => !q || (t.desc.toLowerCase().includes(q) || (t.cat||'').toLowerCase().includes(q)))
        .sort((a,b)=> new Date(b.date||0) - new Date(a.date||0))
        .forEach(t=>{
          const li = document.createElement('li');
          const left = document.createElement('div');
          const right = document.createElement('div');

          left.innerHTML = `<strong>${t.desc}</strong><br><small>${t.cat||'—'} • ${t.date||'—'}</small>`;
          right.innerHTML = `<strong class="${t.type==='expense'?'neg':'pos'}">${fmt(t.type==='expense'?-t.amount:t.amount)}</strong><br><small><a href="#" data-id="${t.id}">Delete</a></small>`;
          li.appendChild(left); li.appendChild(right);
          listEl.appendChild(li);

          if(t.type==='income') income += t.amount; else expense += t.amount;
        });

      incomeTotalEl.textContent = fmt(income);
      expenseTotalEl.textContent = fmt(-expense);
      netTotalEl.textContent = fmt(income - expense);
    }

    function add(){
      const amount = parseFloat(amtEl.value);
      if(!descEl.value || isNaN(amount)) { alert('Add a description and amount'); return; }
      txns.push({
        id: crypto.randomUUID(),
        desc: descEl.value.trim(),
        amount: Math.abs(amount),
        type: typeEl.value,
        cat: catEl.value.trim(),
        date: dateEl.value || new Date().toISOString().slice(0,10)
      });
      save(txns);
      descEl.value=''; amtEl.value=''; catEl.value='';
      render();
    }

    // Delete handler (event delegation)
    listEl.addEventListener('click', e=>{
      const id = e.target.dataset?.id;
      if(id){ txns = txns.filter(t=>t.id!==id); save(txns); render(); }
    });

    // Wire up
    addBtn.addEventListener('click', add);
    searchEl.addEventListener('input', render);
    filterTypeEl.addEventListener('change', render);
    document.addEventListener('DOMContentLoaded', render);

    // Export CSV
    exportBtn.addEventListener('click', ()=>{
      const rows = [['Date','Type','Description','Category','Amount']];
      txns.forEach(t=> rows.push([t.date, t.type, t.desc, t.cat, t.amount]));
      const csv = rows.map(r=> r.map(x=> `"${(x??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'quickbudget.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // PWA: register service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
